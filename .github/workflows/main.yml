name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: root
        password: ${{ secrets.SERVER_PASSWORD }}
        port: 22
        script: |
          # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º git –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          apt update && apt install -y git
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          mkdir -p /var/www/fox-net.site
          cd /var/www/fox-net.site
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º git repo –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if [ ! -d ".git" ]; then
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
          fi
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git fetch --all
          git reset --hard origin/main
          git pull origin main
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
          chown -R www-data:www-data /var/www/fox-net.site
          chmod -R 755 /var/www/fox-net.site
          
          # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
          nginx -t && systemctl reload nginx
          
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Site available at: http://${{ secrets.SERVER_IP }}"
